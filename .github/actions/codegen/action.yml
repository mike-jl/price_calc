name: Generate SQLC + Templ Code
description: Installs tools and runs codegen
runs:
  using: "composite"
  steps:
    - uses: actions/setup-go@v5
      with:
        go-version: 1.24

    - name: Clean Go mod + build cache before restore
      run: |
        sudo rm -rf ~/go/pkg/mod || true
        sudo rm -rf ~/.cache/go-build || true
      shell: bash

    - uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Set SQLCCACHE env var
      run: |
        export SQLCCACHE="$HOME/.cache/sqlc"
        mkdir -p "$SQLCCACHE"
        echo "SQLCCACHE=$SQLCCACHE" >> $GITHUB_ENV

    - uses: actions/cache@v3
      with:
        path: ~/.cache/sqlc
        key: ${{ runner.os }}-sqlc-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-sqlc-

    - name: Pre-download Go modules
      run: go mod download
      shell: bash

    - name: Generate sqlc
      run: go tool sqlc generate
      shell: bash

    - name: Generate templ
      run: go tool templ generate
      shell: bash
